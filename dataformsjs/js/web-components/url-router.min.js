import{render,setElementText,bindAttrTmpl,showError,componentsAreDefined,polyfillCustomElements,showErrorAlert,showOldBrowserWarning}from"./utils.min.js";const shadowTmpl=document.createElement("template");function downloadTemplate(t,e,r,o){const n=r.src;if(null===n||""===n)return showError(e,`Missing <template> or [src] attribute for route [${r.path}].`),void t.dispatchEvent(new Event("contentLoaded"));fetch(n,{mode:"cors",cache:"no-store",credentials:"same-origin"}).then(t=>{const e=t.status;if(e>=200&&e<300||304===e)return Promise.resolve(t);{const r="Error loading data. Server Response Code: "+e+", Response Text: "+t.statusText;return Promise.reject(r)}}).then(t=>t.text()).then(n=>{r.template=n,setView(t,e,n,o)}).catch(r=>{showError(e,r),t.dispatchEvent(new Event("contentLoaded"))})}function setView(t,e,r,o){e.innerHTML=r;let n=e.querySelectorAll("[url-params]");const s=JSON.stringify(o);for(const t of n)t.setAttribute("url-params",s);n=e.querySelectorAll("[url-param]");for(const t of n){const e=t.getAttribute("url-param"),r=void 0===o[e]?"":o[e];setElementText(t,r)}n=e.querySelectorAll("[url-attr-param]");for(const t of n)bindAttrTmpl(t,"url-attr-param",o);polyfillCustomElements();const l=document.querySelectorAll('a[href^="/"]:not([data-no-pushstate]');for(const e of l)e.addEventListener("click",e=>{if(!0!==e.ctrlKey)return e.preventDefault(),e.stopPropagation(),e.currentTarget.href?(window.history.pushState(null,null,e.currentTarget.href),t.updateView()):showErrorAlert("Error, link click does not work because href is missing."),!1});t.dispatchEvent(new Event("contentLoaded"))}shadowTmpl.innerHTML="\n    <style>:host { display:none; }</style>\n    <slot></slot>\n";class UrlRouter extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}).appendChild(shadowTmpl.content.cloneNode(!0)),this._currentRoute=null,this.updateView=this.updateView.bind(this),this.updateView()}connectedCallback(){window.addEventListener("popstate",this.updateView)}disconnectedCallback(){window.removeEventListener("popstate",this.updateView)}get currentRoute(){return this._currentRoute}async updateView(){await componentsAreDefined(this,"url-route"),this._currentRoute=null;const t=this.getAttribute("view-selector");if(null===t||""===t)return void this.showFatalError("Error, element <url-router> is missing attribute [view-selector]");const e=document.querySelector(t);if(null===e)return void this.showFatalError(render`Error, element from <url-router view-selector="${t}"> was not found on the page.`);let r=window.location.pathname;""===r&&(r="/");const o=this.querySelectorAll("url-route");let n=null;for(const t of o){if(null===t.path)return this.showFatalError("Error, element <url-route> is missing attribute [path]"),void console.log(t);const o=this.routeMatches(r,t.path);if(o.isMatch){const r=t.redirect;if(null!==r&&r!==window.location.pathname)return window.history.pushState(null,null,t.redirect),void this.updateView();const n=t.template;return this._currentRoute=t,void(null===n?downloadTemplate(this,e,t,o.urlParams):setView(this,e,n,o.urlParams))}t.isDefault&&(n=t)}if(n){const t=n.path;if(""!==t&&-1===t.indexOf(":"))return window.history.pushState(null,null,t),void this.updateView()}showError(e,`Error - The route [${r}] does not have a matching <url-route> element and no default route is defined using [default-route].`)}routeMatches(t,e){const r=t.split("/"),o=e.split("/"),n=r.length,s={};if(n!==o.length)return{isMatch:!1};for(let t=0;t<n;t++){const e=decodeURIComponent(r[t]);if(e!==o[t]){if(":"!==o[t].substr(0,1))return{isMatch:!1};s[o[t].substr(1)]=e}}return{isMatch:!0,urlParams:s}}showFatalError(t){this.style.display="block",this.style.padding="1em",this.style.backgroundColor="red",this.style.color="white",this.style.fontSize="1.5em",this.textContent=t,this.dispatchEvent(new Event("error")),this.dispatchEvent(new Event("contentLoaded")),console.error(t)}}class UrlRoute extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}).appendChild(shadowTmpl.content.cloneNode(!0))}get path(){return this.getAttribute("path")}get src(){return this.getAttribute("src")}get redirect(){return this.getAttribute("redirect")}get isDefault(){return null!==this.getAttribute("default-route")}get template(){const t=this.querySelector("template");return null===t?null:t.innerHTML}set template(t){let e=this.querySelector("template");null===e&&(e=document.createElement("template"),this.appendChild(e)),e.innerHTML=t}}showOldBrowserWarning(),window.customElements.define("url-router",UrlRouter),window.customElements.define("url-route",UrlRoute);