// @link https://www.dataformsjs.com
// @author Conrad Sollitt (http://www.conradsollitt.com)
// @license MIT
import{buildUrl,setElementText,getBindValue,bindAttrTmpl,componentsAreDefined,polyfillCustomElements,showOldBrowserWarning}from"./utils.min.js";const shadowTmpl=document.createElement("template");shadowTmpl.innerHTML="\n    <style>:host { display:block; }</style>\n    <slot></slot>\n";const dataCache=[];function saveDataToCache(t,e,s){for(const a of dataCache)if(a.url===t)return a.params=JSON.stringify(e),void(a.data=s);dataCache.push({url:t,params:JSON.stringify(e),data:s})}function getDataFromCache(t,e){for(const s of dataCache)if(s.url===t){if(e===s.params||null===e&&"null"===s.params)return s.data;break}return null}class JsonData extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}).appendChild(shadowTmpl.content.cloneNode(!0)),this.state={isLoading:!1,hasError:!1,isLoaded:!1,contentReady:!1,errorMessage:null},this.elements={isLoading:this.querySelector("is-loading"),hasError:this.querySelector("has-error"),isLoaded:this.querySelector("is-loaded")}}static get observedAttributes(){return["url","url-params"]}attributeChangedCallback(t,e){switch(t){case"url":case"url-params":null!==e&&this.fetch()}}connectedCallback(){this.state.isLoading||this.state.hasError||this.state.isLoaded||this.fetch()}get url(){return this.getAttribute("url")}get urlParams(){return this.getAttribute("url-params")}get loadOnlyOnce(){return"true"===this.getAttribute("load-only-once")}get isLoading(){return this.state.isLoading}set isLoading(t){this.state.isLoading=!0===t,this.elements.isLoading&&(this.elements.isLoading.style.display=this.state.isLoading?"":"none"),!0===t&&this.dispatchEvent(new Event("isLoading"))}get hasError(){return this.state.hasError}set hasError(t){this.state.hasError=!0===t,this.elements.hasError&&(this.elements.hasError.style.display=this.state.hasError?"":"none"),!0===t&&this.dispatchEvent(new Event("hasError"))}get isLoaded(){return this.state.isLoaded}set isLoaded(t){this.state.isLoaded=!0===t,this.elements.isLoaded&&(this.elements.isLoaded.style.display=this.state.isLoaded?"":"none"),!0===t&&this.dispatchEvent(new Event("isLoaded"))}get contentReady(){return this.state.contentReady}fetch(){const t=this.url;let e=t;if(null===e||""===e)return this.showError("Error, element <json-data> is missing attribute [url]"),this.state.contentReady=!0,void this.dispatchEvent(new Event("contentReady"));let s=this.getAttribute("url-params");if(""!==s||!e.includes(":")){if(this.loadOnlyOnce){const e=getDataFromCache(t,s);if(null!==e)return this._setLoadedState(e),this.state.contentReady=!0,void this.dispatchEvent(new Event("contentReady"))}s&&(s=JSON.parse(s),e=buildUrl(e,s)),this.isLoading=!0,this.isLoaded=!1,this.hasError=!1,this.state.contentReady=!1,this.bindData(),fetch(e,{mode:"cors",cache:"no-store",credentials:"same-origin"}).then(t=>{const e=t.status;if(e>=200&&e<300||304===e)return Promise.resolve(t);{const s="Error loading data. Server Response Code: "+e+", Response Text: "+t.statusText;return Promise.reject(s)}}).then(t=>t.json()).then(e=>{this.loadOnlyOnce&&saveDataToCache(t,s,e),this._setLoadedState(e)}).catch(t=>{this.showError(t)}).finally(()=>{this.state.contentReady=!0,this.dispatchEvent(new Event("contentReady"))})}}showError(t){this.isLoading=!1,this.isLoaded=!1,this.hasError=!0,this.state.errorMessage=t,this.bindData(),console.error(t)}_setLoadedState(t){this.isLoading=!1,this.isLoaded=!0,this.hasError=!1,this.state.errorMessage=null,Object.assign(this.state,t),"boolean"==typeof t.hasError&&(this.hasError=t.hasError),this.bindData()}async bindData(){await componentsAreDefined(this,"[data-bind]");let t=this.querySelectorAll("[data-bind]");for(const e of t){const t=e.getAttribute("data-bind"),s=""===t?this.state:getBindValue(this.state,t);setElementText(e,s)}t=this.querySelectorAll("[data-bind-attr]");for(const e of t)bindAttrTmpl(e,"data-bind-attr",this.state);polyfillCustomElements()}}showOldBrowserWarning(),window.customElements.define("json-data",JsonData),window.customElements.define("is-loading",class extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}).appendChild(shadowTmpl.content.cloneNode(!0)),"JSON-DATA"===this.parentNode.nodeName&&!0===this.parentNode.isLoading||(this.style.display="none")}}),window.customElements.define("has-error",class extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}).appendChild(shadowTmpl.content.cloneNode(!0)),"JSON-DATA"===this.parentNode.nodeName&&!0===this.parentNode.hasError||(this.style.display="none")}}),window.customElements.define("is-loaded",class extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}).appendChild(shadowTmpl.content.cloneNode(!0)),"JSON-DATA"===this.parentNode.nodeName&&!0===this.parentNode.isLoaded||(this.style.display="none")}});