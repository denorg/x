"use strict";if(void 0===window.exports&&(window.exports=window),void 0===window.React&&void 0!==window.preact)var React=window.preact;function _instanceof(t,e){return null!=e&&"undefined"!=typeof Symbol&&e[Symbol.hasInstance]?!!e[Symbol.hasInstance](t):t instanceof e}function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _classCallCheck(t,e){if(!_instanceof(t,e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var r=0;r<e.length;r++){var o=e[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function _createClass(t,e,r){return e&&_defineProperties(t.prototype,e),r&&_defineProperties(t,r),t}function _possibleConstructorReturn(t,e){return!e||"object"!==_typeof(e)&&"function"!=typeof e?_assertThisInitialized(t):e}function _getPrototypeOf(t){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function _assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&_setPrototypeOf(t,e)}function _setPrototypeOf(t,e){return(_setPrototypeOf=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var jsonDataCache=[],graphQL_Cache={};function saveDataToCache(t,e,r,o){for(var a=0,n=jsonDataCache.length;a<n;a++){var s=jsonDataCache[a];if(s.url===t&&s.query===e)return s.params=JSON.stringify(r),void(s.data=o)}jsonDataCache.push({url:t,query:e,params:JSON.stringify(r),data:o})}function getDataFromCache(t,e,r){for(var o=0,a=jsonDataCache.length;o<a;o++){var n=jsonDataCache[o];if(n.url===t&&n.query===e){if(JSON.stringify(r)===n.params)return n.data;break}}return null}function IsLoading(t){return 0===t.fetchState&&t.children?t.children:null}function HasError(t){if(!(-1===t.fetchState)||!t.children)return null;var e=t.error;return"string"==typeof e&&-1===e.indexOf("Error")&&(e="Error - "+e),React.cloneElement(t.children,{error:e})}function IsLoaded(t){return 1===t.fetchState&&t.children?React.cloneElement(t.children,{data:t.data,params:t.params,handleChange:t.handleChange}):null}var JsonData=function(){function r(t){var e;return _classCallCheck(this,r),(e=_possibleConstructorReturn(this,_getPrototypeOf(r).call(this,t)))._isFetching=!1,e._isMounted=!1,e.fetchData=e.fetchData.bind(_assertThisInitialized(e)),e.handleChange=e.handleChange.bind(_assertThisInitialized(e)),e.state={fetchState:0,error:null,params:e.getUrlParams(),data:null},e}return _inherits(r,React.Component),_createClass(r,[{key:"getUrlParams",value:function(){var t={};if(this.props&&!0===this.props.graphQL)return void 0===this.props.variables?{}:this.props.variables;for(var e in this.props)"url"!==e&&"string"==typeof this.props[e]&&(t[e]=this.props[e]);return t}},{key:"componentDidMount",value:function(){if((this._isMounted=!0)===this.props.graphQL&&void 0===this.props.query&&void 0!==this.props.querySrc&&void 0!==graphQL_Cache[this.props.querySrc]&&(this.props.query=graphQL_Cache[this.props.querySrc]),this.props.loadOnlyOnce){var t=getDataFromCache(this.props.url,this.props.query,this.getUrlParams());if(null!==t)return void this.setState({fetchState:1,data:t})}if(!0!==this.props.graphQL||void 0!==this.props.query||void 0===this.props.querySrc)this.fetchData();else{var e=this.props.querySrc,r=this;fetch(e,null).then(function(t){var e=t.status;if(200<=e&&e<300||304===e)return Promise.resolve(t);var r="Error loading data. Server Response Code: "+e+", Response Text: "+t.statusText;return Promise.reject(r)}).then(function(t){return t.text()}).then(function(t){graphQL_Cache[e]=t,r.props.query=graphQL_Cache[e],r.fetchData()}).catch(function(t){throw new Error("Error Downloading GraphQL Script: ["+e+"], Error: "+t.toString())})}}},{key:"componentDidUpdate",value:function(t,e){var r;!0===this.props.graphQL?r=JSON.stringify(t.variables)!==JSON.stringify(this.props.variables):r=this.buildUrl(e.params)!==this.buildUrl(this.props);r&&this.setState({params:this.getUrlParams()},this.fetchData)}},{key:"componentWillUnmount",value:function(){this._isMounted=!1}},{key:"buildUrl",value:function(t){var e=this.props.url;if(!0!==this.props.graphQL&&0<Object.keys(t).length)for(var r in t)-1<e.indexOf(":"+r)&&(e=e.replace(new RegExp(":"+r,"g"),encodeURIComponent(t[r])));return e}},{key:"fetchData",value:function(){var o=this,t=this.buildUrl(this.state.params);if(!this._isFetching){this._isFetching=!0;var e={mode:"cors",cache:"no-store",credentials:"same-origin"};if(this.props.fetchOptions&&(e=this.props.fetchOptions),this.props.fetchHeaders&&(e.headers=this.props.fetchHeaders),!0===this.props.graphQL){var r=void 0===this.props.variables?{}:this.props.variables;"file://"===window.location.origin||"null"===window.location.origin?(t+=-1===t.indexOf("?")?"?":"&",t+="query="+encodeURIComponent(this.props.query.trim()),t+="&variables="+encodeURIComponent(JSON.stringify(r))):(e.method="POST",void 0===e.headers?e.headers={"Content-Type":"application/json"}:e.headers["Content-Type"]="application/json",e.body=JSON.stringify({query:this.props.query,variables:r}))}this.setState({fetchState:0},function(){o.updateView(),fetch(t,e).then(function(t){var e=t.status;if(200<=e&&e<300||304===e)return Promise.resolve(t);var r="Error loading data. Server Response Code: "+e+", Response Text: "+t.statusText;return Promise.reject(r)}).then(function(t){return t.json()}).then(function(t){var e=!0===o.props.graphQL;if(e&&t.errors&&t.errors.length){var r;if(1===t.errors.length&&t.errors[0].message)r="[GraphQL Error]: "+t.errors[0].message;else r=("string"==typeof o.props.errorTextGraphQLErrors?o.props.errorTextGraphQLErrors:"{count} GraphQL Errors occured. See console for full details.").replace("{count}",t.errors.length);throw console.error(t.errors),r}o._isMounted&&o.setState({fetchState:1,data:e?t.data:t}),o.props.loadOnlyOnce&&saveDataToCache(o.props.url,o.props.query,o.getUrlParams(),e?t.data:t)}).catch(function(t){o._isMounted&&o.setState({fetchState:-1,error:t.toString()})}).finally(function(){o._isFetching=!1,o.updateView()})})}}},{key:"handleChange",value:function(t){var e=0<arguments.length&&void 0!==t?t:null;this._isMounted&&this.setState({data:null===e?this.state.data:e})}},{key:"updateView",value:function(){if("function"==typeof this.props.onViewUpdated)try{this.props.onViewUpdated()}catch(t){console.error(t)}}},{key:"render",value:function(){return React.createElement(React.Fragment,null,React.createElement(IsLoading,{fetchState:this.state.fetchState},this.props.isLoading),React.createElement(HasError,{fetchState:this.state.fetchState,error:this.state.error},this.props.hasError),React.createElement(IsLoaded,{fetchState:this.state.fetchState,data:this.state.data,params:this.state.params,handleChange:this.handleChange},this.props.isLoaded))}}]),r}();exports.default=JsonData;